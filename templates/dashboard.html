{% extends "base.html" %}
{% block title %}Dashboard - SisResiduos{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row g-3">
    <!-- KPIs -->
    <div class="col-12">
      <div class="row">
        <div class="col-md-3">
          <div class="card text-white bg-success">
            <div class="card-body">
              <h6 class="card-title">Contenedores activos</h6>
              <h3 class="card-text">{{ kpi.containers_active or 0 }}</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-white bg-danger">
            <div class="card-body">
              <h6 class="card-title">Alertas críticas</h6>
              <h3 class="card-text">{{ kpi.critical_alerts or 0 }}</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-white bg-primary">
            <div class="card-body">
              <h6 class="card-title">Prom. llenado (%)</h6>
              <h3 class="card-text">{{ kpi.avg_fill or '—' }}</h3>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-white bg-info">
            <div class="card-body">
              <h6 class="card-title">Mediciones (hoy)</h6>
              <h3 class="card-text">{{ kpi.measurements_today or 0 }}</h3>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Map + Charts -->
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header">Mapa de contenedores (estado)</div>
        <div class="card-body p-0">
          <div id="map" style="height:420px;"></div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card mb-3">
        <div class="card-header">Promedio de llenado por tipo de residuo</div>
        <div class="card-body">
          <canvas id="chartFillByType" height="200"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="card-header">Temperatura promedio por hora</div>
        <div class="card-body">
          <canvas id="chartTempByHour" height="150"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // MAP (Leaflet) - placeholder
  const map = L.map('map').setView([4.7, -74.0], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Example: add markers from server-side list `containers` (passed by Flask)
  {% if containers %}
    {% for c in containers %}
      L.marker([{{ c.lat }}, {{ c.lng }}]).addTo(map).bindPopup("Contenedor {{ c.id }} - {{ c.tipo }}");
    {% endfor %}
  {% endif %}

  // Chart.js - Fill by type
  const ctx1 = document.getElementById('chartFillByType').getContext('2d');
  const chartFillByType = new Chart(ctx1, {
    type: 'bar',
    data: {
      labels: {{ chart.fill.labels | tojson }},
      datasets: [{
        label: 'Promedio llenado (%)',
        data: {{ chart.fill.data | tojson }},
        borderWidth: 1
      }]
    },
    options: { responsive: true }
  });

  // Chart.js - Temp by hour
  const ctx2 = document.getElementById('chartTempByHour').getContext('2d');
  const chartTempByHour = new Chart(ctx2, {
    type: 'line',
    data: {
      labels: {{ chart.temp.labels | tojson }},
      datasets: [{ label: '°C', data: {{ chart.temp.data | tojson }}, tension: 0.3 }]
    },
    options: { responsive: true }
  });
</script>
{% endblock %}
